<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro — Granja (PWA)</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b1220">
  <link rel="icon" href="./icon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="./icon.svg">

  <style>
    :root{
      --bg:#0b1220;
      --text:#e6eefc;
      --muted:#a7b6d6;
      --accent:#67e8f9;
      --accent2:#a78bfa;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 12px 28px rgba(0,0,0,.38);
      --radius: 14px;
      --radius2: 18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --card: rgba(255,255,255,.04);
      --stroke: rgba(255,255,255,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(1100px 650px at 20% 0%, rgba(103,232,249,.14), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(167,139,250,.12), transparent 55%),
        var(--bg);
      color:var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header{
      padding:12px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.80);
      z-index:20;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:0 14px 24px;}
    .wrap.hd{padding:0}

    .topbar{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .tabs{
      display:flex;
      gap:8px;
      width:100%;
      flex-wrap:nowrap;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar{display:none;}

    .tabbtn{
      flex:1 1 0;
      min-width: 0;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:12px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:900;
      font-size:12.5px;
      min-height:44px;
      text-align:center;
      white-space:nowrap;
    }
    .tabbtn.active{
      border-color: rgba(103,232,249,.40);
      background: linear-gradient(180deg, rgba(103,232,249,.22), rgba(103,232,249,.08));
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }

    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-size:12px;color: var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background: var(--accent);}

    .panel{margin-top:12px;display:none;}
    .panel.active{display:block;}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.07);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .card .hd h2{margin:0;font-size:13.5px;letter-spacing:.25px;font-weight:900;color:#dbeafe;}
    .card .bd{padding:14px;}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      background: rgba(15,23,42,.75);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      padding:12px 12px;
      border-radius: 12px;
      outline:none;
      min-height:44px;
      font-size:14px;
    }
    textarea{min-height:92px}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(103,232,249,.55);
      box-shadow: 0 0 0 3px rgba(103,232,249,.14);
    }

    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .grid3{display:grid;grid-template-columns: 1.2fr .7fr .7fr auto;gap:10px;align-items:end;}
    .grid4{display:grid;grid-template-columns: 1.2fr .9fr .7fr .7fr;gap:10px;align-items:end;}
    @media (max-width: 920px){
      .grid2,.grid3,.grid4{grid-template-columns:1fr;}
      header{padding:12px 14px 12px;}
      .wrap{padding:0 12px 24px;}
    }

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:900;
      font-size:12.5px;
      min-height:44px;
    }
    button.primary{
      border-color: rgba(103,232,249,.35);
      background: linear-gradient(180deg, rgba(103,232,249,.22), rgba(103,232,249,.08));
    }
    button.ok{
      border-color: rgba(52,211,153,.35);
      background: linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.07));
    }
    button.danger{
      border-color: rgba(251,113,133,.35);
      background: linear-gradient(180deg, rgba(251,113,133,.18), rgba(251,113,133,.07));
    }
    button.ghost{background: transparent;}
    button:active{transform: translateY(1px)}
    button.full{flex:1 1 220px}
    button[disabled]{opacity:.45;cursor:not-allowed;transform:none;}

    .muted{color:var(--muted)}
    .safePad{padding-bottom: env(safe-area-inset-bottom, 0px);}

    .note{
      margin-top:12px;
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size:12.5px;
      line-height:1.45;
    }

    .ticket{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(15,23,42,.20);
      border-radius:18px;
      overflow:hidden;
    }
    .ticketHd{
      padding:12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .ticketHd .title{font-weight:900;color:#dbeafe;font-size:13px;}
    .ticketBd{padding:12px;}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      font-weight:900;color:#dbeafe;font-size:12px;
      margin-right:8px;
    }

    /* Items del recorrido: tabla simple (solo quitar) */
    .itemsWrap{
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
      background: rgba(15,23,42,.22);
    }
    .itemsHeader, .itemsRow{
      display:grid;
      grid-template-columns: 1fr 140px 180px 160px;
      gap:10px;
      padding:10px 12px;
      align-items:center;
    }
    .itemsHeader{
      position:sticky;
      top:0;
      background: rgba(11,18,32,.92);
      border-bottom:1px solid rgba(255,255,255,.06);
      color:#dbeafe;
      font-weight:900;
      font-size:12.5px;
    }
    .itemsRow{
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:12.5px;
    }
    .itemsRow:last-child{border-bottom:none;}
    .itemsRow .right{text-align:right;}
    .itemsRow button{
      min-height:36px;
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      width:100%;
    }
    @media (max-width: 920px){
      .itemsHeader{display:none;}
      .itemsRow{
        grid-template-columns: 1fr;
        gap:8px;
      }
      .itemsRow .right{text-align:left;}
      .itemsRow .cellLabel{
        display:flex;justify-content:space-between;gap:10px;
        padding:10px;
        border:1px solid rgba(255,255,255,.08);
        border-radius:14px;
        background: rgba(255,255,255,.03);
      }
      .itemsRow .cellLabel strong{font-weight:900;}
    }

    /* Recorridos del día: mini tarjetas */
    .tripCards{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 980px){ .tripCards{grid-template-columns: 1fr 1fr;} }
    @media (max-width: 560px){ .tripCards{grid-template-columns: 1fr;} }

    .tripCard{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(15,23,42,.22);
      border-radius:18px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .tripCardTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .tripMeta .t{font-weight:900;color:#dbeafe;font-size:13px;}
    .tripMeta .s{color:var(--muted);font-size:12px;margin-top:4px;line-height:1.35;}
    .tripCardBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tripCardBtns button{
      flex:1 1 120px;
      min-height:38px;
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
    }

    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index:200;
    }
    .overlay.open{display:block;}
    .modal{
      position:fixed;
      inset: 0;
      display:none;
      z-index:210;
      padding: 14px;
      align-items:center;
      justify-content:center;
    }
    .modal.open{display:flex;}
    .modalCard{
      width: min(920px, 100%);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.96);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modalHd{
      padding:12px 12px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalHd .t{font-weight:900;color:#dbeafe;}
    .modalBd{padding:12px;}
    .modalFt{
      padding:12px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .modalFt button{flex:1 1 220px}

    .toast{
      position:fixed;
      right:14px;
      bottom:14px;
      max-width: 420px;
      z-index:300;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .toast .msg{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(15,23,42,.92);
      box-shadow: var(--shadow);
      font-size:12.5px;
      color: var(--text);
    }

    /* Monthly */
    .monthSummary{margin: 8px 0 16px; display:flex; flex-direction:column; gap:12px;}
    .summaryTop{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px;}
    .summaryStat{
      padding:14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
    }
    .summaryStat .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .summaryStat .value{font-size:22px; font-weight:900; line-height:1.1;}
    .summaryStat .meta{font-size:12px; color:var(--muted); margin-top:6px; line-height:1.35;}
    .summaryGrid{display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px;}
    .summaryBox{
      padding:14px;
      border-radius:18px;
      border:1px solid rgba(103,232,249,.22);
      background: linear-gradient(180deg, rgba(103,232,249,.08), rgba(15,23,42,.35));
      position:relative;
      overflow:hidden;
    }
    .summaryBox::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:4px;
      background: linear-gradient(90deg, rgba(103,232,249,.65), rgba(167,139,250,.55));
    }
    .summaryTitle{font-size:13px; font-weight:900; margin-bottom:10px; color:#e0f2fe; text-transform:uppercase; letter-spacing:.35px;}
    .summaryTableWrap{
      overflow:auto;
      border:1px solid rgba(255,255,255,.08);
      border-radius:14px;
      background: rgba(11,18,32,.55);
    }
    .summaryTableWrap table{min-width:0; width:100%;}
    .summaryTableWrap th{background: rgba(11,18,32,.85);}
    .summaryTableWrap td{font-size:12.5px;}
    .sectionTitle{margin-top:6px; font-size:13px; font-weight:900; color:#dbeafe;}
    @media (max-width: 1020px){
      .summaryTop,.summaryGrid{grid-template-columns: 1fr;}
    }
    @media (max-width: 720px){
      .summaryTableWrap{border:none;background: transparent;}
      .summaryTableWrap table{width:100%;}
      .summaryTableWrap thead{display:none;}
      .summaryTableWrap tbody{display:flex;flex-direction:column;gap:10px;}
      .summaryTableWrap tr{
        display:flex;
        flex-direction:column;
        gap:8px;
        padding:12px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,.10);
        background: rgba(15,23,42,.55);
      }
      .summaryTableWrap tr.summaryEmpty{
        text-align:center;
        align-items:center;
      }
      .summaryTableWrap td{
        display:flex;
        align-items:center;
        justify-content:space-between;
        padding:0;
        border:none;
        font-size:13px;
      }
      .summaryTableWrap td::before{
        content:attr(data-label);
        font-size:11px;
        color:var(--muted);
        font-weight:700;
        text-transform:uppercase;
        letter-spacing:.3px;
      }
      .summaryTableWrap tr.summaryEmpty td::before{
        content:"";
      }
    }

    .tableWrap{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:auto;
      background: rgba(15,23,42,.22);
      max-height: 520px;
      display:block;
    }
    table{border-collapse:collapse; width:100%; min-width: 760px;}
    th, td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.06); font-size:12.5px;}
    th{position:sticky; top:0; background: rgba(11,18,32,.92); z-index:2; text-align:left; color:#dbeafe; font-weight:900;}
    td{color:var(--text)}
    .right{text-align:right}
    .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
    .actions button{min-height:34px;padding:7px 10px;border-radius:12px;font-weight:900;font-size:12px}

    /* ===== Print-like blocks inside modals (match exported info) ===== */
    .printLike{
      background:#fff;
      color:#111;
      border-radius:18px;
      border:1px solid rgba(0,0,0,.12);
      overflow:hidden;
    }
    .printLike .pHd{
      padding:14px 14px 10px;
    }
    .printLike .pHd h1{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .printLike .pMeta{
      padding:0 14px 12px;
      font-size:13px;
      color:#111;
      line-height:1.6;
    }
    .printLike .pMeta strong{font-weight:900;}
    .printLike .pTableWrap{
      padding:0 14px 12px;
    }
    .printLike table{
      width:100%;
      min-width:0;
      border-collapse:collapse;
      font-size:13px;
      color:#111;
    }
    .printLike th, .printLike td{
      border:1px solid #e5e7eb;
      padding:10px 10px;
      vertical-align:top;
    }
    .printLike th{
      background:#f3f4f6;
      color:#111;
      position:static;
      font-weight:900;
    }
    .printLike td{
      color:#111;
    }
    .printLike td.right{text-align:right;}
    .printLike .muted2{color:#333;font-size:12px;margin-top:2px;}
    .printLike .pObs{
      margin:0 14px 14px;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .printLike .pObsTitle{
      font-weight:900;
      color:#1f1f1f;
      margin-bottom:6px;
    }
    .printLike .pObsBody{
      color:#111;
      white-space:pre-wrap;
    }

    /* Day summary modal layout */
    .dayGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:12px;
    }
    @media (max-width: 860px){
      .dayGrid{grid-template-columns: 1fr;}
    }
    .dayCard{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .dayCard .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .dayCard .btnRow button{
      flex:1 1 180px;
      min-height:40px;
      padding:10px 12px;
      border-radius:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap hd">
    <div style="padding:0 14px">
      <div class="topbar">
        <div class="tabs" role="tablist" aria-label="Secciones">
          <button class="tabbtn active" id="tabNew" role="tab" aria-selected="true">Nuevo</button>
          <button class="tabbtn" id="tabDaily" role="tab" aria-selected="false">Diario</button>
          <button class="tabbtn" id="tabMonthly" role="tab" aria-selected="false">Mensual</button>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap safePad">

  <!-- PANEL: NUEVO -->
  <section class="panel active" id="panelNew" role="tabpanel" aria-labelledby="tabNew">
    <div class="card">
      <div class="hd">
        <div></div>
      </div>

      <div class="bd">
        <div class="btns" id="newTripTopArea" style="margin-top:0">
          <button class="primary full" id="openNewTripModalBtn">Habilitar nuevo recorrido</button>
        </div>

        <div id="activeTripHeader" style="display:none; margin-top:12px;">
          <div class="note" style="margin-top:0">
            <span id="activeTripInfo"></span>
            <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
              <span class="badge" title="Suma de cantidades de ítems con categoría 'Visitante'">
                <span class="dot" style="background: var(--ok)"></span>
                <span>Visitantes: <strong id="activeTripVisitors">0</strong></span>
              </span>

              <span class="badge" title="Total del recorrido">
                <span class="dot" style="background: var(--accent)"></span>
                <span>Total: <strong id="activeTripTotal">Bs 0</strong></span>
              </span>
              <button class="ghost" id="closeActiveTripBtn" title="Cerrar el recorrido en edición (no borra nada)">Cerrar edición</button>
            </div>
          </div>

          <div class="ticket" style="margin-top:12px;">
            <div class="ticketBd">
              <label>Observaciones</label>
              <textarea id="tripNotes" placeholder="Ej: Grupo escolar, lluvia, se retrasó el turno, etc."></textarea>
            </div>
          </div>

          <div class="ticket" style="margin-top:12px;">
            <div class="ticketHd">
              <div class="title">Agregar ítem</div>
            </div>

            <div class="ticketBd">
              <div class="grid3">
                <div>
                  <label>Ítem</label>
                  <select id="itemType"></select>
                </div>
                <div>
                  <label>Cantidad</label>
                  <input id="itemQty" type="number" min="0" step="1" value="0" />
                </div>
                <div>
                  <label>Precio unitario (Bs)</label>
                  <input id="itemPrice" type="number" min="0" step="0.01" value="0" />
                </div>
                <div>
                  <button class="ok" id="addItemBtn">Agregar</button>
                </div>
              </div>
            </div>
          </div>

          <div class="ticket">
            <div class="ticketHd">
              <div class="title">Ítems del recorrido</div>
            </div>
            <div class="ticketBd">
              <div class="itemsWrap">
                <div class="itemsHeader">
                  <div>Ítem</div>
                  <div class="right">Cantidad</div>
                  <div class="right">Total (Bs)</div>
                  <div class="right">Acción</div>
                </div>
                <div id="activeTripItems"></div>
              </div>
            </div>
          </div>

          <div class="btns">
            <button class="primary full" id="openNewTripModalBtn2">Habilitar nuevo recorrido</button>
          </div>
        </div>

        <div class="ticket" style="margin-top:12px;">
          <div class="ticketHd">
            <div class="title">Resumen del recorrido</div>
            <button class="ok" id="exportTripPdfBtn">Exportar recorrido</button>
          </div>
          <div class="ticketBd">
            <div class="printLike" id="summaryPrintLike">
              <div class="pHd">
                <h1>Resumen de recorrido</h1>
              </div>

              <div class="pMeta">
                <div><strong>Fecha:</strong> <span id="summaryDate">—</span></div>
                <div><strong>Turno:</strong> <span id="summaryShift">—</span></div>
                <div><strong>Hora:</strong> <span id="summaryHour">—</span></div>
                <div><strong>Visitantes:</strong> <span id="summaryVisitors">0</span></div>
                <div><strong>Total:</strong> <span id="summaryTotalTop">Bs 0</span></div>
              </div>

              <div class="pTableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>Ítem</th>
                      <th class="right" style="width:110px;">Cantidad</th>
                      <th class="right" style="width:150px;">Subtotal (Bs)</th>
                    </tr>
                  </thead>
                  <tbody id="summaryTbody"></tbody>
                  <tfoot>
                    <tr>
                      <td colspan="2" class="right"><strong>Total</strong></td>
                      <td class="right"><strong id="summaryTotalFoot">Bs 0</strong></td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="pObs">
                <div class="pObsTitle">Observaciones</div>
                <div class="pObsBody" id="summaryNotes">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PANEL: DAILY -->
  <section class="panel" id="panelDaily" role="tabpanel" aria-labelledby="tabDaily">
    <div class="card">
      <div class="hd">
        <div></div>
      </div>

      <div class="bd">
        <!-- Fecha a listar: selector pequeño + Hoy -->
        <div style="margin-top:0;display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;">
          <div style="min-width:160px;max-width:190px;flex:0 0 auto;">
            <label>Fecha a listar</label>
            <input id="listDate" type="date" style="padding:10px 10px;min-height:40px;" />
          </div>
          <div style="flex:0 0 auto; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="ghost" id="listTodayBtn" style="min-height:40px;padding:10px 12px;border-radius:12px;">Hoy</button>
          </div>
        </div>

        <div class="tripCards" id="tripCards"></div>
        <div class="note" id="storageHint"></div>

        <div class="ticket" style="margin-top:12px;">
          <div class="ticketHd">
            <div class="title">Resumen del día</div>
            <button class="ok" id="exportDayPdfBtn">Exportar</button>
          </div>
          <div class="ticketBd">
            <div class="note" style="margin-top:0">
              Fecha: <strong id="daySummaryDateInline">—</strong>
            </div>
            <div class="dayGrid" id="daySummaryInlineGrid" style="margin-top:12px;"></div>
            <div class="note" id="daySummaryInlineEmpty" style="display:none;">No hay recorridos para esta fecha.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- PANEL: MONTHLY -->
  <section class="panel" id="panelMonthly" role="tabpanel" aria-labelledby="tabMonthly">
    <div class="card">
      <div class="hd">
        <h2>Resumen mensual (Gerencia)</h2>
        <div class="btns" style="margin:0;">
          <button class="ok" id="reportBtn">Reporte (PDF/Imprimir)</button>
          <button class="ok" id="exportBtn">Exportar (JSON)</button>
          <button id="importBtn">Importar (JSON)</button>
          <button id="openTariffBtn">Tarifa</button>
        </div>
      </div>

      <div class="bd">
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end;justify-content:space-between;">
          <div style="min-width:190px">
            <label>Mes activo</label>
            <input id="month" type="month" />
          </div>
          <div class="badge" title="Mes seleccionado">
            <span class="dot" style="background: var(--accent2)"></span>
            <span>Mes activo: <strong id="monthBadge">—</strong></span>
          </div>
        </div>

        <div class="monthSummary">
          <div class="summaryTop">
            <div class="summaryStat">
              <div class="label">Total $ del mes</div>
              <div class="value" id="monthSummaryRevenue">Bs 0</div>
              <div class="meta" id="monthSummaryMeta">—</div>
            </div>
            <div class="summaryStat">
              <div class="label">Total visitantes del mes</div>
              <div class="value" id="monthSummaryVisitors">0</div>
              <div class="meta" id="monthSummaryVisitorsMeta">—</div>
            </div>
          </div>

          <div class="summaryGrid">
            <div class="summaryBox">
              <div class="summaryTitle">Detalle de visitantes</div>
              <div class="summaryTableWrap">
                <table class="summaryTable">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th class="right" style="width:120px;">Cantidad</th>
                      <th class="right" style="width:160px;">Total (Bs)</th>
                    </tr>
                  </thead>
                  <tbody id="monthVisitorsTbody"></tbody>
                </table>
              </div>
            </div>

            <div class="summaryBox">
              <div class="summaryTitle">Detalle de extras</div>
              <div class="summaryTableWrap">
                <table class="summaryTable">
                  <thead>
                    <tr>
                      <th>Extra</th>
                      <th class="right" style="width:120px;">Cantidad</th>
                      <th class="right" style="width:160px;">Total (Bs)</th>
                    </tr>
                  </thead>
                  <tbody id="monthExtrasTbody"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="sectionTitle">Detalle por día</div>
        <div class="tableWrap" style="max-height:520px;">
          <table>
            <thead>
              <tr>
                <th style="width:140px">Fecha</th>
                <th class="right">Visitantes</th>
                <th class="right">Total día</th>
                <th class="right" style="width:140px">Acciones</th>
              </tr>
            </thead>
            <tbody id="monthTbody"></tbody>
          </table>
        </div>

        <div class="note" id="monthInfo"></div>
      </div>
    </div>
  </section>

  <!-- PANEL: TARIFARIO -->
  <section class="panel" id="panelTariff" role="tabpanel" aria-labelledby="openTariffBtn">
    <div class="card">
      <div class="hd">
        <h2>Tarifario (Catálogo de ítems)</h2>
        <div class="badge" title="Los ítems deshabilitados no aparecen en el combo del Registro diario.">
          <span class="dot" style="background: var(--ok)"></span>
          <span>Combo: solo habilitados</span>
        </div>
      </div>

      <div class="bd">
        <div class="note" style="margin-top:0">
          <span class="pill">Regla de borrado</span>
          Un ítem <strong>solo se puede borrar</strong> si <strong>nunca fue usado</strong> en un recorrido. Si ya se usó, podrás <strong>deshabilitarlo</strong>.
        </div>

        <div class="ticket" style="margin-top:12px">
          <div class="ticketHd">
            <div>
              <div class="title" id="tariffFormTitle">Nuevo ítem</div>
              <div class="muted" style="font-size:12px;margin-top:2px">Crea o edita ítems del combo.</div>
            </div>
            <div class="badge">
              <span class="dot" style="background: var(--accent2)"></span>
              <span>Total ítems: <strong id="tariffCount">0</strong></span>
            </div>
          </div>
          <div class="ticketBd">
            <div class="grid4">
              <div>
                <label>Nombre (visible)</label>
                <input id="tariffLabel" type="text" placeholder="Ej: Vuelta — Pony" />
              </div>
              <div>
                <label>Categoría</label>
                <select id="tariffCategory">
                  <option value="visitor">Visitante</option>
                  <option value="extra">Extra</option>
                </select>
              </div>
              <div>
                <label>Precio por defecto (Bs)</label>
                <input id="tariffPrice" type="number" min="0" step="0.01" placeholder="0.00" />
              </div>
              <div>
                <label>Estado</label>
                <select id="tariffEnabled">
                  <option value="true">Habilitado</option>
                  <option value="false">Deshabilitado</option>
                </select>
              </div>
            </div>

            <div class="btns">
              <button class="ok full" id="tariffSaveBtn">Guardar</button>
              <button class="ghost full" id="tariffCancelBtn" disabled>Cancelar edición</button>
            </div>
          </div>
        </div>

        <div class="tableWrap" style="max-height:520px;">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th style="width:140px">Categoría</th>
                <th class="right" style="width:150px">Precio defecto</th>
                <th style="width:130px">Estado</th>
                <th class="right" style="width:280px">Acciones</th>
              </tr>
            </thead>
            <tbody id="tariffTbody"></tbody>
          </table>
        </div>

        <div class="btns">
          <button class="danger full" id="tariffResetBtn" title="Restaura el tarifario base. No borra recorridos.">
            Restaurar tarifario base
          </button>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Modales -->
<div class="overlay" id="modalOverlay"></div>

<!-- Modal: nuevo recorrido -->
<div class="modal" id="newTripModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHd">
      <div class="t">Habilitar nuevo recorrido</div>
      <button class="ghost" id="closeModalBtn" style="min-height:40px;border-radius:12px">Cerrar</button>
    </div>
    <div class="modalBd">
      <div class="grid3" style="grid-template-columns: 1fr 1fr 1fr;">
        <div>
          <label>Fecha</label>
          <input id="newTripDate" type="date" />
        </div>
        <div>
          <label>Turno</label>
          <select id="newTripShift">
            <option value="manana">Mañana</option>
            <option value="tarde">Tarde</option>
          </select>
        </div>
        <div>
          <label>Hora</label>
          <input id="newTripHour" type="time" />
        </div>
      </div>
    </div>
    <div class="modalFt">
      <button class="ghost" id="cancelModalBtn">Cancelar</button>
      <button class="ok" id="acceptNewTripBtn">Aceptar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(() => {
  "use strict";

  // ===== PWA bootstrap (actualizaciones) =====
  (function pwaInit(){
    const isSecure = location.protocol === "https:" || location.hostname === "localhost";
    const isFile = location.protocol === "file:";
    if (isFile || !isSecure) return;
    if (!("serviceWorker" in navigator)) return;

    const swUrl = "./sw.js";
    let hadController = !!navigator.serviceWorker.controller;

    navigator.serviceWorker.register(swUrl).then((registration) => {
      const askForUpdate = () => {
        const waiting = registration.waiting;
        if (!waiting) return;
        const ok = window.confirm("Hay una nueva versión disponible. ¿Deseas actualizar ahora?");
        if (!ok) return;
        waiting.postMessage({ type: "SKIP_WAITING" });
      };

      if (registration.waiting && navigator.serviceWorker.controller) {
        askForUpdate();
      }

      registration.addEventListener("updatefound", () => {
        const newWorker = registration.installing;
        if (!newWorker) return;
        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            askForUpdate();
          }
        });
      });

      navigator.serviceWorker.addEventListener("controllerchange", () => {
        if (!hadController) {
          hadController = true;
          return;
        }
        window.location.reload();
      });
    }).catch(()=>{});
  })();

  // ===== Keys =====
  const STORAGE_KEY = "kalomai_granja_monthly_v8";
  const CATALOG_KEY = "kalomai_granja_tarifario_v2";

  // ===== Base tarifario =====
  const BASE_CATALOG = [
    { id:"resort",  label:"Resort",  category:"visitor", defaultPrice: 0,  isEnabled:true },
    { id:"school",  label:"Colegio", category:"visitor", defaultPrice: 0,  isEnabled:true },
    { id:"park",    label:"Parque",  category:"visitor", defaultPrice: 0,  isEnabled:true },

    { id:"horse",   label:"Caballo", category:"extra",   defaultPrice: 10, isEnabled:true },
    { id:"pony",    label:"Pony",    category:"extra",   defaultPrice: 10, isEnabled:true },
    { id:"cup",     label:"Taza",    category:"extra",   defaultPrice: 10, isEnabled:true },
  ];

  const $ = (id) => document.getElementById(id);

  function pad2(n){ return String(n).padStart(2,"0"); }
  function toISODate(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
  function toMonthKeyFromISODate(iso){ return iso.slice(0,7); }

  function formatDateDDMMYY(iso){
    if(!iso || typeof iso !== "string" || iso.length < 10) return iso || "—";
    const y = iso.slice(2,4);
    const m = iso.slice(5,7);
    const d = iso.slice(8,10);
    return `${d}-${m}-${y}`;
  }

  function safeInt(v){
    const n = Number(v);
    return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 0;
  }
  function safeMoney(v){
    const n = Number(v);
    if(!Number.isFinite(n)) return 0;
    return Math.max(0, Math.round(n * 100) / 100);
  }
  function fmtMoney(n){
    const val = Math.round(n * 100) / 100;
    return `Bs ${val}`;
  }
  function esc(s){
    return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }
  function toast(msg){
    const host = $("toast");
    const el = document.createElement("div");
    el.className = "msg";
    el.textContent = msg;
    host.appendChild(el);
    setTimeout(()=>{ el.style.opacity="0"; el.style.transition="opacity .35s"; }, 2200);
    setTimeout(()=>{ el.remove(); }, 2700);
  }
  function confirmDanger(message){ return window.confirm(message); }
  function uid(){
    return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + "_" + Date.now()));
  }
  function catLabel(cat){
    return (cat === "visitor") ? "Visitante" : "Extra";
  }

  // ===== Store =====
  function loadStore(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return { days:{} };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return { days:{} };
      if(!obj.days || typeof obj.days !== "object") obj.days = {};
      for(const k of Object.keys(obj.days)){
        if(!Array.isArray(obj.days[k].trips)) obj.days[k].trips = [];
      }
      return obj;
    }catch{
      return { days:{} };
    }
  }
  function saveStore(store){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(store));
  }
  function ensureDay(store, isoDate){
    if(!store.days[isoDate]) store.days[isoDate] = { trips:[], updatedAt: new Date().toISOString() };
    if(!Array.isArray(store.days[isoDate].trips)) store.days[isoDate].trips = [];
    return store.days[isoDate];
  }
  function findTrip(store, isoDate, tripId){
    const day = store.days?.[isoDate];
    if(!day) return null;
    return (day.trips || []).find(t => t.id === tripId) || null;
  }
  function upsertTrip(store, isoDate, trip){
    const day = ensureDay(store, isoDate);
    const idx = day.trips.findIndex(t => t.id === trip.id);
    if(idx === -1) day.trips.push(trip);
    else day.trips[idx] = trip;
    day.updatedAt = new Date().toISOString();
  }
  function deleteTrip(store, isoDate, tripId){
    const day = store.days?.[isoDate];
    if(!day) return;
    day.trips = (day.trips || []).filter(t => t.id !== tripId);
    day.updatedAt = new Date().toISOString();
    if(day.trips.length === 0) delete store.days[isoDate];
  }

  // ===== Catalog =====
  function seedBaseCatalog(){
    const now = new Date().toISOString();
    const seeded = BASE_CATALOG.map(x => ({
      id: x.id,
      label: x.label,
      category: x.category,
      defaultPrice: safeMoney(x.defaultPrice),
      isEnabled: x.isEnabled !== false,
      createdAt: now,
      updatedAt: now
    }));
    localStorage.setItem(CATALOG_KEY, JSON.stringify(seeded));
    return seeded;
  }
  function loadCatalog(){
    try{
      const raw = localStorage.getItem(CATALOG_KEY);
      if(!raw) return seedBaseCatalog();
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr) || arr.length === 0) return seedBaseCatalog();
      const normalized = arr.map(x => ({
        id: String(x.id || uid()),
        label: String(x.label || "Ítem"),
        category: (String(x.category || "extra") === "visitor" ? "visitor" : "extra"),
        defaultPrice: safeMoney(x.defaultPrice),
        isEnabled: (x.isEnabled !== false),
        createdAt: x.createdAt || new Date().toISOString(),
        updatedAt: x.updatedAt || new Date().toISOString()
      }));
      localStorage.setItem(CATALOG_KEY, JSON.stringify(normalized));
      return normalized;
    }catch{
      return seedBaseCatalog();
    }
  }

  let CATALOG = [];
  let CAT_BY_ID = {};
  function refreshCatalogCache(){
    CATALOG = loadCatalog();
    CAT_BY_ID = Object.fromEntries(CATALOG.map(x => [x.id, x]));
    $("tariffCount").textContent = String(CATALOG.length);
  }
  function enabledCatalog(){ return CATALOG.filter(x => x.isEnabled); }
  function saveCatalog(cat){
    localStorage.setItem(CATALOG_KEY, JSON.stringify(cat));
    refreshCatalogCache();
    rebuildItemTypeSelect();
    rebuildChartMetricOptions();
    renderTariff();
    renderDailyList();
    renderMonthly();
  }

  function isTypeUsedInTrips(typeId){
    const store = loadStore();
    for(const date of Object.keys(store.days || {})){
      const trips = store.days[date]?.trips || [];
      for(const t of trips){
        const items = t.items || [];
        for(const it of items){
          if(it.typeId === typeId) return true;
        }
      }
    }
    return false;
  }

  // ===== Calculations =====
  function normalizeItem(typeId, qty, unitPrice){
    const def = CAT_BY_ID[typeId];
    const category = (def?.category === "visitor") ? "visitor" : "extra";
    return {
      typeId,
      label: def?.label || "Ítem",
      category,
      qty: safeInt(qty),
      unitPrice: safeMoney(unitPrice)
    };
  }

  function calcItems(items){
    const acc = {
      qtyByType: {},
      incomeByType: {},
      qtyVisitors: 0,
      incomeTotal: 0
    };
    for(const it of (items || [])){
      const qty = safeInt(it.qty);
      const price = safeMoney(it.unitPrice);
      const sub = qty * price;
      const typeId = String(it.typeId || "");
      const cat = (String(it.category || "extra") === "visitor") ? "visitor" : "extra";

      acc.qtyByType[typeId] = (acc.qtyByType[typeId] || 0) + qty;
      acc.incomeByType[typeId] = (acc.incomeByType[typeId] || 0) + sub;
      acc.incomeTotal += sub;

      if(cat === "visitor") acc.qtyVisitors += qty;
    }
    return acc;
  }
  function calcTrip(trip){ return calcItems(trip?.items || []); }

  function listDaysForMonth(store, monthKey){
    return Object.keys(store.days)
      .filter(d => d.startsWith(monthKey + "-"))
      .sort((a,b)=>a.localeCompare(b));
  }

  function monthTotals(store, monthKey){
    const days = listDaysForMonth(store, monthKey);
    const totals = {
      adults:0,minors:0,seniors:0,
      entries:0, pony:0, horse:0, cups:0,
      revenue:0, daysCount:0, tripsCount:0,
      incomeByType: {}
    };
    for(const d of days){
      const trips = store.days[d]?.trips || [];
      totals.daysCount++;
      totals.tripsCount += trips.length;

      for(const t of trips){
        const c = calcTrip(t);

        totals.adults  += (c.qtyByType["adult"]  || 0);
        totals.minors  += (c.qtyByType["minor"]  || 0);
        totals.seniors += (c.qtyByType["senior"] || 0);
        totals.entries += (c.qtyByType["adult"]  || 0) + (c.qtyByType["minor"] || 0) + (c.qtyByType["senior"] || 0);

        totals.pony  += (c.qtyByType["pony"]  || 0);
        totals.horse += (c.qtyByType["horse"] || 0);
        totals.cups  += (c.qtyByType["cups"]  || 0);

        totals.revenue += c.incomeTotal;

        for(const [typeId, inc] of Object.entries(c.incomeByType || {})){
          totals.incomeByType[typeId] = (totals.incomeByType[typeId] || 0) + inc;
        }
      }
    }
    return totals;
  }

  function buildMonthlySummary(store, monthKey){
    const days = listDaysForMonth(store, monthKey);
    const byType = new Map();
    let totalRevenue = 0;
    let visitorsQty = 0;
    let tripsCount = 0;

    for(const d of days){
      const trips = store.days[d]?.trips || [];
      tripsCount += trips.length;

      for(const t of trips){
        const items = Array.isArray(t.items) ? t.items : [];
        for(const it of items){
          const qty = safeInt(it.qty);
          const unitPrice = safeMoney(it.unitPrice);
          const subtotal = qty * unitPrice;
          const typeId = String(it.typeId || "");
          const def = CAT_BY_ID[typeId];
          const label = String(it.label || def?.label || "Ítem");
          const category = (String(it.category || def?.category || "extra") === "visitor") ? "visitor" : "extra";

          totalRevenue += subtotal;
          if(category === "visitor") visitorsQty += qty;

          const prev = byType.get(typeId);
          if(!prev){
            byType.set(typeId, { typeId, label, category, qty, subtotal });
          } else {
            prev.qty += qty;
            prev.subtotal += subtotal;
          }
        }
      }
    }

    const allRows = Array.from(byType.values());
    const sortRows = (a,b)=>a.label.localeCompare(b.label);

    return {
      daysCount: days.length,
      tripsCount,
      totalRevenue,
      visitorsQty,
      visitorTypes: allRows.filter(r => r.category === "visitor").sort(sortRows),
      extraTypes: allRows.filter(r => r.category !== "visitor").sort(sortRows)
    };
  }

  // ===== Tabs =====
  function toggleTab(btn, active){
    if(!btn) return;
    btn.classList.toggle("active", active);
    btn.setAttribute("aria-selected", active ? "true" : "false");
  }

  function togglePanel(panel, active){
    if(!panel) return;
    panel.classList.toggle("active", active);
  }

  function setActiveTab(tab){
    const newBtn = $("tabNew");
    const dailyBtn = $("tabDaily");
    const monthBtn = $("tabMonthly");
    const tariffBtn = $("tabTariff");
    const newPanel = $("panelNew");
    const dailyPanel = $("panelDaily");
    const monthPanel = $("panelMonthly");
    const tariffPanel = $("panelTariff");

    const newActive = tab === "new";
    const dailyActive = tab === "daily";
    const monthActive = tab === "monthly";
    const tariffActive = tab === "tariff";

    toggleTab(newBtn, newActive);
    toggleTab(dailyBtn, dailyActive);
    toggleTab(monthBtn, monthActive);
    toggleTab(tariffBtn, tariffActive);

    togglePanel(newPanel, newActive);
    togglePanel(dailyPanel, dailyActive);
    togglePanel(monthPanel, monthActive);
    togglePanel(tariffPanel, tariffActive);

    if(newActive || dailyActive) renderDaily();
    if(monthActive) renderMonthly();
    if(tariffActive) renderTariff();
  }
  $("tabNew").addEventListener("click", ()=> setActiveTab("new"));
  $("tabDaily").addEventListener("click", ()=> setActiveTab("daily"));
  $("tabMonthly").addEventListener("click", ()=> setActiveTab("monthly"));

  // ===== Daily state =====
  let activeTripDate = null;
  let activeTripId = null;

  function setActiveTrip(date, id){
    activeTripDate = date;
    activeTripId = id;
    localStorage.setItem("kalomai_active_trip_date", activeTripDate || "");
    localStorage.setItem("kalomai_active_trip_id", activeTripId || "");
  }
  function loadActiveTripFromStorage(){
    const d = String(localStorage.getItem("kalomai_active_trip_date") || "").trim();
    const id = String(localStorage.getItem("kalomai_active_trip_id") || "").trim();
    if(d && id){
      const store = loadStore();
      const t = findTrip(store, d, id);
      if(t){ activeTripDate = d; activeTripId = id; return; }
    }
    activeTripDate = null; activeTripId = null;
  }
  function getActiveTrip(){
    if(!activeTripDate || !activeTripId) return null;
    const store = loadStore();
    return findTrip(store, activeTripDate, activeTripId);
  }

  function showActiveTripUI(trip){
    $("newTripTopArea").style.display = trip ? "none" : "flex";
    $("activeTripHeader").style.display = trip ? "block" : "none";

    if(!trip) return;

    const shiftText = (trip.shift === "manana" ? "Mañana" : "Tarde");
    $("activeTripInfo").innerHTML =
      `Fecha <strong>${esc(formatDateDDMMYY(activeTripDate))}</strong> · Turno <strong>${esc(shiftText)}</strong> · Hora <strong>${esc(trip.tripHour || "—")}</strong>`;
  }

  // ===== Daily: combo with placeholder =====
  function resetAddLine(){
    const sel = $("itemType");
    sel.value = "";
    $("itemQty").value = "0";
    $("itemPrice").value = "0";
  }

  function rebuildItemTypeSelect(){
    const sel = $("itemType");
    const enabled = enabledCatalog();

    if(enabled.length === 0){
      sel.innerHTML = `<option value="">(No hay ítems habilitados)</option>`;
      sel.disabled = true;
      $("addItemBtn").disabled = true;
      resetAddLine();
      return;
    }

    sel.disabled = false;
    $("addItemBtn").disabled = false;

    sel.innerHTML =
      `<option value="">Seleccionar ítem</option>` +
      enabled
        .slice()
        .sort((a,b)=>a.label.localeCompare(b.label))
        .map(x => `<option value="${esc(x.id)}">${esc(x.label)}</option>`)
        .join("");

    resetAddLine();
  }

  $("itemType").addEventListener("change", ()=>{
    const id = $("itemType").value;
    if(!id){
      resetAddLine();
      return;
    }
    const def = CAT_BY_ID[id];
    $("itemQty").value = "1";
    $("itemPrice").value = String(safeMoney(def?.defaultPrice ?? 0));
  });

  // ===== Modales =====
  const overlay = $("modalOverlay");
  const newTripModal = $("newTripModal");

  function openNewTripModal(){
    overlay.classList.add("open");
    newTripModal.classList.add("open");
    newTripModal.setAttribute("aria-hidden","false");

    const today = toISODate(new Date());
    $("newTripDate").value = $("listDate").value || today;
    $("newTripShift").value = "manana";
    $("newTripHour").value = "";
    $("newTripHour").focus();
  }

  function closeAllModals(){
    overlay.classList.remove("open");
    newTripModal.classList.remove("open");
    newTripModal.setAttribute("aria-hidden","true");
  }

  $("openNewTripModalBtn").addEventListener("click", openNewTripModal);
  $("openNewTripModalBtn2").addEventListener("click", openNewTripModal);
  $("closeModalBtn").addEventListener("click", closeAllModals);
  $("cancelModalBtn").addEventListener("click", closeAllModals);
  overlay.addEventListener("click", closeAllModals);

  $("acceptNewTripBtn").addEventListener("click", ()=>{
    const date = String($("newTripDate").value || "").trim();
    const shift = String($("newTripShift").value || "").trim();
    const hour = String($("newTripHour").value || "").trim();

    if(!date){ toast("Selecciona una fecha."); return; }
    if(!hour){ toast("La hora es obligatoria."); $("newTripHour").focus(); return; }
    if(shift !== "manana" && shift !== "tarde"){ toast("Turno inválido."); return; }

    const store = loadStore();
    const trip = {
      id: uid(),
      shift,
      tripHour: hour,
      notes: "",
      items: [],
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    upsertTrip(store, date, trip);
    saveStore(store);

    setActiveTrip(date, trip.id);
    closeAllModals();
    toast("Recorrido habilitado.");

    $("listDate").value = date;
    renderDaily();
  });

  $("closeActiveTripBtn").addEventListener("click", ()=>{
    setActiveTrip(null, null);
    toast("Edición cerrada.");
    renderDaily();
  });

  // ===== Observaciones (autosave con debounce) =====
  let notesTimer = null;
  function saveActiveNotesDebounced(){
    clearTimeout(notesTimer);
    notesTimer = setTimeout(()=> {
      const trip = getActiveTrip();
      if(!trip) return;

      const store = loadStore();
      const current = findTrip(store, activeTripDate, activeTripId);
      if(!current) return;

      current.notes = String($("tripNotes").value || "");
      current.updatedAt = new Date().toISOString();
      upsertTrip(store, activeTripDate, current);
      saveStore(store);
      renderTripSummaryInline(current);
    }, 300);
  }
  $("tripNotes").addEventListener("input", saveActiveNotesDebounced);

  // ===== Agregar ítem (guardado automático) =====
  $("addItemBtn").addEventListener("click", ()=>{
    const trip = getActiveTrip();
    if(!trip){
      toast("Primero habilita o carga un recorrido.");
      return;
    }
    const typeId = $("itemType").value;
    const qty = safeInt($("itemQty").value);
    const price = safeMoney($("itemPrice").value);

    if(!typeId){
      toast("Selecciona un ítem.");
      return;
    }
    if(qty <= 0){
      toast("La cantidad debe ser mayor a 0.");
      return;
    }

    const store = loadStore();
    const current = findTrip(store, activeTripDate, activeTripId);
    if(!current){
      toast("No se encontró el recorrido activo.");
      setActiveTrip(null,null);
      renderDaily();
      return;
    }

    current.items = Array.isArray(current.items) ? current.items : [];
    current.items.push(normalizeItem(typeId, qty, price));
    current.updatedAt = new Date().toISOString();

    upsertTrip(store, activeTripDate, current);
    saveStore(store);

    resetAddLine();
    toast("Ítem agregado y guardado.");
    renderDaily();
  });

  // ===== Items del recorrido: NO editable (solo quitar) =====
  function renderActiveTripItems(trip){
    const host = $("activeTripItems");
    if(!trip){ host.innerHTML = ""; return; }

    const items = Array.isArray(trip.items) ? trip.items : [];
    if(items.length === 0){
      host.innerHTML = `<div class="itemsRow"><div class="muted">Este recorrido está vacío.</div></div>`;
      return;
    }

    host.innerHTML = items.map((it, idx) => {
      const qty = safeInt(it.qty);
      const up = safeMoney(it.unitPrice);
      const sub = qty * up;

      return `
        <div class="itemsRow">
          <div class="cellLabel">
            <span><strong>${esc(it.label || "Ítem")}</strong></span>
            <span class="muted">${esc(catLabel(it.category || "extra"))}</span>
          </div>

          <div class="right cellLabel">
            <span class="muted">Cantidad</span>
            <strong>${qty}</strong>
          </div>

          <div class="right cellLabel">
            <span class="muted">Total</span>
            <strong>${fmtMoney(sub)}</strong>
          </div>

          <div class="right">
            <button class="danger" data-act="remove" data-idx="${idx}">Quitar</button>
          </div>
        </div>
      `;
    }).join("");

    host.querySelectorAll("button[data-act='remove']").forEach(btn => {
      btn.addEventListener("click", ()=>{
        const idx = Number(btn.getAttribute("data-idx"));
        if(!Number.isFinite(idx)) return;
        if(!confirmDanger("¿Quitar este ítem del recorrido?")) return;
        removeActiveItem(idx);
      });
    });
  }

  function removeActiveItem(idx){
    const store = loadStore();
    const trip = findTrip(store, activeTripDate, activeTripId);
    if(!trip){ toast("No se encontró el recorrido activo."); return; }

    const items = Array.isArray(trip.items) ? trip.items : [];
    if(idx < 0 || idx >= items.length) return;

    items.splice(idx, 1);
    trip.items = items;
    trip.updatedAt = new Date().toISOString();
    upsertTrip(store, activeTripDate, trip);
    saveStore(store);

    toast("Ítem eliminado.");
    renderDaily();
  }

  // ===== Resumen: consolidación + impresión =====
  function buildTripSummary(trip){
    const items = Array.isArray(trip.items) ? trip.items : [];
    const byType = new Map();

    for(const it of items){
      const typeId = String(it.typeId || "");
      const qty = safeInt(it.qty);
      const sub = safeMoney(it.unitPrice) * qty;
      const label = String(it.label || CAT_BY_ID[typeId]?.label || "Ítem");
      const category = (String(it.category || "extra") === "visitor") ? "visitor" : "extra";

      const prev = byType.get(typeId);
      if(!prev){
        byType.set(typeId, { typeId, label, category, qty, subtotal: sub });
      } else {
        prev.qty += qty;
        prev.subtotal += sub;
      }
    }

    const rows = Array.from(byType.values())
      .sort((a,b)=>a.category.localeCompare(b.category) || a.label.localeCompare(b.label));

    const total = rows.reduce((s,r)=>s + r.subtotal, 0);
    return { rows, total };
  }

  function buildTripPrintHTML(dateIso, trip){
    const shiftText = (trip.shift === "manana" ? "Mañana" : "Tarde");
    const c = calcTrip(trip);
    const summary = buildTripSummary(trip);

    const rowsHtml = summary.rows.map(r => `
      <tr>
        <td style="padding:8px;border:1px solid #ddd;">
          <strong>${esc(r.label)}</strong>
          <div style="font-size:11px;color:#444;margin-top:2px;">${esc(catLabel(r.category))}</div>
        </td>
        <td style="padding:8px;border:1px solid #ddd;text-align:right;"><strong>${r.qty}</strong></td>
        <td style="padding:8px;border:1px solid #ddd;text-align:right;"><strong>${fmtMoney(r.subtotal)}</strong></td>
      </tr>
    `).join("");

    const notes = String(trip.notes || "").trim();

    return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Recorrido ${esc(formatDateDDMMYY(dateIso))} ${esc(shiftText)} ${esc(trip.tripHour||"")}</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; margin:24px; color:#111;}
  h1{margin:0 0 8px; font-size:18px;}
  .meta{font-size:12px; color:#444; margin-bottom:14px; line-height:1.45;}
  table{width:100%; border-collapse:collapse; font-size:12px;}
  th{background:#f4f6f8; text-align:left;}
  th, td{border:1px solid #ddd; padding:8px; vertical-align:top;}
  .right{text-align:right;}
  .box{margin-top:14px; border:1px solid #ddd; border-radius:10px; padding:10px;}
  .label{font-size:11px; color:#444; margin-bottom:6px;}
  tr{page-break-inside:avoid;}
  @media print{ body{margin:14mm;} }
</style>
</head>
<body>
  <h1>Resumen de recorrido</h1>
  <div class="meta">
    <div><strong>Fecha:</strong> ${esc(formatDateDDMMYY(dateIso))}</div>
    <div><strong>Turno:</strong> ${esc(shiftText)}</div>
    <div><strong>Hora:</strong> ${esc(trip.tripHour || "—")}</div>
    <div><strong>Visitantes:</strong> ${c.qtyVisitors}</div>
    <div><strong>Total:</strong> ${fmtMoney(summary.total)}</div>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ítem</th>
        <th class="right" style="width:120px;">Cantidad</th>
        <th class="right" style="width:160px;">Subtotal (Bs)</th>
      </tr>
    </thead>
    <tbody>${rowsHtml || ""}</tbody>
    <tfoot>
      <tr>
        <td colspan="2" class="right"><strong>Total</strong></td>
        <td class="right"><strong>${fmtMoney(summary.total)}</strong></td>
      </tr>
    </tfoot>
  </table>

  <div class="box">
    <div class="label"><strong>Observaciones</strong></div>
    <div style="white-space:pre-wrap;">${notes ? esc(notes) : "—"}</div>
  </div>

  <script>
    window.addEventListener("load", () => { try { window.focus(); } catch(e) {} window.print(); });
  </scr` + `ipt>
</body>
</html>`;
  }

  function printTrip(dateIso, trip){
    const html = buildTripPrintHTML(dateIso, trip);
    const w = window.open("", "_blank");
    if(!w){ toast("No se pudo abrir la impresión (bloqueo de popups)."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

  function renderTripSummaryInline(trip){
    if(!trip){
      $("summaryDate").textContent = "—";
      $("summaryShift").textContent = "—";
      $("summaryHour").textContent = "—";
      $("summaryVisitors").textContent = "0";
      $("summaryTotalTop").textContent = "Bs 0";
      $("summaryTotalFoot").textContent = "Bs 0";
      $("summaryNotes").textContent = "—";
      $("summaryTbody").innerHTML = `<tr><td colspan="3" style="color:#444;">No hay recorrido activo.</td></tr>`;
      $("exportTripPdfBtn").disabled = true;
      return;
    }

    const shiftText = (trip.shift === "manana" ? "Mañana" : "Tarde");
    const c = calcTrip(trip);
    const summary = buildTripSummary(trip);

    $("summaryDate").textContent = formatDateDDMMYY(activeTripDate);
    $("summaryShift").textContent = shiftText;
    $("summaryHour").textContent = trip.tripHour || "—";
    $("summaryVisitors").textContent = String(c.qtyVisitors);
    $("summaryTotalTop").textContent = fmtMoney(summary.total);
    $("summaryTotalFoot").textContent = fmtMoney(summary.total);
    $("summaryNotes").textContent = String(trip.notes || "").trim() || "—";

    $("summaryTbody").innerHTML = summary.rows.length
      ? summary.rows.map(r => `
          <tr>
            <td>
              <strong>${esc(r.label)}</strong>
              <div class="muted2">${esc(catLabel(r.category))}</div>
            </td>
            <td class="right"><strong>${r.qty}</strong></td>
            <td class="right"><strong>${fmtMoney(r.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr><td colspan="3" style="color:#444;">No hay ítems en este recorrido.</td></tr>`;
    $("exportTripPdfBtn").disabled = false;
  }

  $("exportTripPdfBtn").addEventListener("click", ()=>{
    const trip = getActiveTrip();
    if(!trip){ toast("No hay un recorrido activo."); return; }
    printTrip(activeTripDate, trip);
  });

  // ===== Resumen del día (inline, diferenciado por turno) =====
  function buildSummaryFromTrips(trips){
    const byType = new Map();
    let total = 0;
    let qtyVisitors = 0;

    for(const t of (trips || [])){
      const items = Array.isArray(t.items) ? t.items : [];
      for(const it of items){
        const qty = safeInt(it.qty);
        const sub = safeMoney(it.unitPrice) * qty;
        const typeId = String(it.typeId || "");
        const label = String(it.label || CAT_BY_ID[typeId]?.label || "Ítem");
        const category = (String(it.category || "extra") === "visitor") ? "visitor" : "extra";

        total += sub;
        if(category === "visitor") qtyVisitors += qty;

        const prev = byType.get(typeId);
        if(!prev){
          byType.set(typeId, { typeId, label, category, qty, subtotal: sub });
        } else {
          prev.qty += qty;
          prev.subtotal += sub;
        }
      }
    }

    const rows = Array.from(byType.values())
      .sort((a,b)=>a.category.localeCompare(b.category) || a.label.localeCompare(b.label));

    return { rows, total, qtyVisitors };
  }

  function buildDayShiftBlock(shiftLabel, trips, options = {}){
    const summary = buildSummaryFromTrips(trips);
    const titleText = options.title ? esc(options.title) : `Turno: ${esc(shiftLabel)}`;
    const rows = summary.rows.length
      ? summary.rows.map(r => `
          <tr>
            <td>
              <strong>${esc(r.label)}</strong>
              <div class="muted2">${esc(catLabel(r.category))}</div>
            </td>
            <td class="right"><strong>${r.qty}</strong></td>
            <td class="right"><strong>${fmtMoney(r.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr><td colspan="3" style="color:#444;">Sin ítems registrados.</td></tr>`;

    return `
      <div class="printLike">
        <div class="pHd">
          <h1>${titleText}</h1>
        </div>

        <div class="pMeta">
          <div><strong>Recorridos:</strong> ${trips.length}</div>
          <div><strong>Visitantes:</strong> ${summary.qtyVisitors}</div>
          <div><strong>Total:</strong> ${fmtMoney(summary.total)}</div>
        </div>

        <div class="pTableWrap">
          <table>
            <thead>
              <tr>
                <th>Ítem</th>
                <th class="right" style="width:110px;">Cantidad</th>
                <th class="right" style="width:150px;">Subtotal (Bs)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <td colspan="2" class="right"><strong>Total</strong></td>
                <td class="right"><strong>${fmtMoney(summary.total)}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    `;
  }

  function renderDaySummaryInline(){
    const iso = String($("listDate").value || "").trim();
    const grid = $("daySummaryInlineGrid");
    const empty = $("daySummaryInlineEmpty");

    $("daySummaryDateInline").textContent = iso ? formatDateDDMMYY(iso) : "—";
    grid.innerHTML = "";

    if(!iso){
      empty.textContent = "Selecciona una fecha para ver el resumen.";
      empty.style.display = "block";
      $("exportDayPdfBtn").disabled = true;
      return;
    }

    const store = loadStore();
    const tripsRaw = store.days?.[iso]?.trips || [];
    const trips = Array.isArray(tripsRaw) ? tripsRaw.slice() : [];

    if(trips.length === 0){
      empty.textContent = "No hay recorridos para esta fecha.";
      empty.style.display = "block";
      $("exportDayPdfBtn").disabled = true;
      return;
    }

    empty.style.display = "none";

    const morningTrips = trips.filter(t => t.shift === "manana");
    const afternoonTrips = trips.filter(t => t.shift === "tarde");

    grid.innerHTML = [
      buildDayShiftBlock("Mañana", morningTrips),
      buildDayShiftBlock("Tarde", afternoonTrips),
      buildDayShiftBlock("Total del día", trips, { title: "Total del día" })
    ].join("");

    $("exportDayPdfBtn").disabled = false;
  }

  function buildDayPrintHTML(dateIso, trips){
    const morningTrips = trips.filter(t => t.shift === "manana");
    const afternoonTrips = trips.filter(t => t.shift === "tarde");
    const dateLabel = esc(formatDateDDMMYY(dateIso));

    const buildShiftSection = (shiftLabel, shiftTrips) => {
      const summary = buildSummaryFromTrips(shiftTrips);
      const rows = summary.rows.length
        ? summary.rows.map(r => `
            <tr>
              <td style="padding:8px;border:1px solid #ddd;">
                <strong>${esc(r.label)}</strong>
                <div style="font-size:11px;color:#444;margin-top:2px;">${esc(catLabel(r.category))}</div>
              </td>
              <td style="padding:8px;border:1px solid #ddd;text-align:right;"><strong>${r.qty}</strong></td>
              <td style="padding:8px;border:1px solid #ddd;text-align:right;"><strong>${fmtMoney(r.subtotal)}</strong></td>
            </tr>
          `).join("")
        : `<tr><td colspan="3" style="padding:8px;border:1px solid #ddd;color:#444;">Sin ítems registrados.</td></tr>`;

      return `
        <div class="block">
          <h2>Turno: ${esc(shiftLabel)}</h2>
          <div class="meta">
            <div><strong>Recorridos:</strong> ${shiftTrips.length}</div>
            <div><strong>Visitantes:</strong> ${summary.qtyVisitors}</div>
            <div><strong>Total:</strong> ${fmtMoney(summary.total)}</div>
          </div>

          <table>
            <thead>
              <tr>
                <th>Ítem</th>
                <th style="text-align:right;width:120px;">Cantidad</th>
                <th style="text-align:right;width:160px;">Subtotal (Bs)</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr>
                <td colspan="2" style="text-align:right;"><strong>Total</strong></td>
                <td style="text-align:right;"><strong>${fmtMoney(summary.total)}</strong></td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    };

    return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Resumen del día ${dateLabel}</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; margin:24px; color:#111;}
  h1{margin:0 0 6px; font-size:18px;}
  h2{margin:0 0 6px; font-size:14px;}
  .meta{font-size:12px; color:#444; margin-bottom:10px; line-height:1.45;}
  .block{margin-top:16px;}
  table{width:100%; border-collapse:collapse; font-size:12px;}
  th, td{border:1px solid #ddd; padding:8px; vertical-align:top;}
  th{background:#f4f6f8; text-align:left;}
  @media print{ body{margin:14mm;} }
</style>
</head>
<body>
  <h1>Resumen del día — ${dateLabel}</h1>
  <div class="meta">Totales diferenciados por turno.</div>
  ${buildShiftSection("Mañana", morningTrips)}
  ${buildShiftSection("Tarde", afternoonTrips)}
  ${buildShiftSection("Total del día", trips)}

  <script>
    window.addEventListener("load", () => { try { window.focus(); } catch(e) {} window.print(); });
  </scr` + `ipt>
</body>
</html>`;
  }

  function printDaySummary(dateIso, trips){
    const html = buildDayPrintHTML(dateIso, trips);
    const w = window.open("", "_blank");
    if(!w){ toast("No se pudo abrir la impresión (bloqueo de popups)."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }

  // ===== Listado diario (mini tarjetas) =====
  $("listTodayBtn").addEventListener("click", ()=>{
    $("listDate").value = toISODate(new Date());
    renderDailyList();
    toast("Fecha actual seleccionada.");
  });
  $("listDate").addEventListener("change", renderDailyList);

  $("exportDayPdfBtn").addEventListener("click", ()=>{
    const iso = String($("listDate").value || "").trim();
    if(!iso){ toast("Selecciona una fecha."); return; }

    const store = loadStore();
    const tripsRaw = store.days?.[iso]?.trips || [];
    const trips = Array.isArray(tripsRaw) ? tripsRaw.slice() : [];
    if(trips.length === 0){
      toast("No hay recorridos para exportar.");
      return;
    }
    printDaySummary(iso, trips);
  });

  function renderDailyList(){
    const iso = String($("listDate").value || "").trim();
    const store = loadStore();

    const host = $("tripCards");
    host.innerHTML = "";

    if(!iso){
      host.innerHTML = `<div class="note">Selecciona una fecha.</div>`;
      $("storageHint").textContent = `Registros guardados: ${Object.keys(store.days).length}.`;
      renderDaySummaryInline();
      return;
    }

    const tripsRaw = store.days?.[iso]?.trips || [];
    const trips = Array.isArray(tripsRaw) ? tripsRaw.slice() : [];

    trips.sort((a,b)=>{
      const sa = a.shift === "manana" ? 0 : 1;
      const sb = b.shift === "manana" ? 0 : 1;
      if(sa !== sb) return sa - sb;
      const ha = (a.tripHour || "99:99");
      const hb = (b.tripHour || "99:99");
      if(ha !== hb) return ha.localeCompare(hb);
      return (a.createdAt || "").localeCompare(b.createdAt || "");
    });

    if(trips.length === 0){
      host.innerHTML = `<div class="note">No hay recorridos para este día.</div>`;
      $("storageHint").textContent = `Registros guardados (días): ${Object.keys(store.days).length}.`;
      renderDaySummaryInline();
      return;
    }

    host.innerHTML = trips.map(t=>{
      const c = calcTrip(t);
      const shift = t.shift === "manana" ? "Mañana" : "Tarde";
      return `
        <div class="tripCard">
          <div class="tripCardTop">
            <div class="tripMeta">
              <div class="t">${esc(t.tripHour || "—")}</div>
              <div class="s">
                Turno: <strong>${esc(shift)}</strong><br>
                Visitantes: <strong>${c.qtyVisitors}</strong>
              </div>
            </div>
          </div>
          <div class="tripCardBtns">
            <button class="ghost" data-act="view" data-id="${esc(t.id)}">Ver</button>
            <button class="danger" data-act="del" data-id="${esc(t.id)}">Borrar</button>
          </div>
        </div>
      `;
    }).join("");

    host.querySelectorAll("button[data-act='view']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        setActiveTrip(iso, id);
        toast("Recorrido cargado para edición.");
        setActiveTab("new");
        renderDaily();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    });

    host.querySelectorAll("button[data-act='del']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        if(!confirmDanger("¿Borrar este recorrido?")) return;

        const store2 = loadStore();
        deleteTrip(store2, iso, id);
        saveStore(store2);

        if(activeTripDate === iso && activeTripId === id){
          setActiveTrip(null,null);
        }

        toast("Recorrido eliminado.");
        renderDaily();
      });
    });

    $("storageHint").textContent = `Día ${iso}: ${trips.length} recorridos. Registros guardados (días): ${Object.keys(store.days).length}.`;
    renderDaySummaryInline();
  }

  // ===== Daily render principal =====
  function renderDaily(){
    refreshCatalogCache();
    rebuildItemTypeSelect();

    const trip = getActiveTrip();
    showActiveTripUI(trip);

    if(trip){
      const c = calcTrip(trip);
      $("activeTripVisitors").textContent = String(c.qtyVisitors);
      $("activeTripTotal").textContent = fmtMoney(c.incomeTotal);
      $("tripNotes").value = String(trip.notes || "");
      renderActiveTripItems(trip);
      renderTripSummaryInline(trip);
    } else {
      $("activeTripVisitors").textContent = "0";
      $("activeTripTotal").textContent = "Bs 0";
      $("tripNotes").value = "";
      $("activeTripItems").innerHTML = "";
      renderTripSummaryInline(null);
    }

    renderDailyList();
  }

  // ===== Monthly: chart metric selector dinámico =====
  function rebuildChartMetricOptions(){
    const sel = $("chartMetric");
    if(!sel) return;
    const all = CATALOG.slice().sort((a,b)=>a.label.localeCompare(b.label));

    const general = [
      { value:"visitors_qty", label:"Visitantes (cantidad)" },
      { value:"revenue_total", label:"Ingresos (Bs)" },
    ];
    const qtyItems = all.map(it => ({ value:`qty:${it.id}`, label:`${it.label} — Cantidad` }));
    const revItems = all.map(it => ({ value:`rev:${it.id}`, label:`${it.label} — Ingresos (Bs)` }));

    sel.innerHTML = `
      <optgroup label="General">
        ${general.map(x => `<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("")}
      </optgroup>
      <optgroup label="Ítems (Cantidad)">
        ${qtyItems.map(x => `<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("")}
      </optgroup>
      <optgroup label="Ítems (Ingresos)">
        ${revItems.map(x => `<option value="${esc(x.value)}">${esc(x.label)}</option>`).join("")}
      </optgroup>
    `;

    const current = sel.getAttribute("data-current") || "visitors_qty";
    const has = Array.from(sel.options).some(o => o.value === current);
    sel.value = has ? current : "visitors_qty";
  }

  const weekdayLabels = ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"];
  const mapGetDayToMonFirstIndex = (getDay) => (getDay === 0 ? 6 : getDay - 1);

  function buildWeekdayAgg(store, monthKey){
    const days = Object.keys(store.days)
      .filter(d => d.startsWith(monthKey + "-"))
      .sort((a,b)=>a.localeCompare(b));

    const agg = Array.from({length:7}, () => ({
      visitorsQty:0,
      revenueTotal:0,
      qtyByType:{},
      revByType:{}
    }));

    for(const date of days){
      const dtDate = new Date(date + "T00:00:00");
      const idx = mapGetDayToMonFirstIndex(dtDate.getDay());
      const trips = store.days[date]?.trips || [];
      for(const t of trips){
        const c = calcTrip(t);
        agg[idx].visitorsQty += c.qtyVisitors;
        agg[idx].revenueTotal += c.incomeTotal;

        for(const [typeId, q] of Object.entries(c.qtyByType || {})){
          agg[idx].qtyByType[typeId] = (agg[idx].qtyByType[typeId] || 0) + q;
        }
        for(const [typeId, r] of Object.entries(c.incomeByType || {})){
          agg[idx].revByType[typeId] = (agg[idx].revByType[typeId] || 0) + r;
        }
      }
    }
    return agg;
  }

  function drawBarChart(values, options){
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");

    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(240 * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const w = rect.width;
    const h = 240;
    ctx.clearRect(0,0,w,h);

    const gridColor = "rgba(255,255,255,0.08)";
    const textColor = "rgba(230,238,252,0.92)";
    const mutedColor = "rgba(167,182,214,0.85)";
    const barColor = "rgba(103,232,249,0.60)";

    const padding = {l:44, r:14, t:18, b:34};
    const plotW = w - padding.l - padding.r;
    const plotH = h - padding.t - padding.b;

    const maxVal = Math.max(1, ...values.map(v => v.value));
    const yTicks = 4;

    ctx.font = "12px system-ui";
    ctx.fillStyle = mutedColor;
    ctx.strokeStyle = gridColor;
    ctx.lineWidth = 1;

    for(let i=0;i<=yTicks;i++){
      const y = padding.t + (plotH * (i / yTicks));
      ctx.beginPath();
      ctx.moveTo(padding.l, y);
      ctx.lineTo(padding.l + plotW, y);
      ctx.stroke();

      const val = maxVal * (1 - i / yTicks);
      ctx.textAlign = "left";
      ctx.fillText(options.formatY(val), 6, y + 4);
    }

    const gap = 10;
    const barW = (plotW - gap * (values.length - 1)) / values.length;

    values.forEach((v, i) => {
      const x = padding.l + i * (barW + gap);
      const barH = (v.value / maxVal) * plotH;
      const y = padding.t + (plotH - barH);

      ctx.fillStyle = barColor;
      ctx.fillRect(x, y, barW, barH);

      ctx.fillStyle = mutedColor;
      ctx.textAlign = "center";
      ctx.fillText(v.label, x + barW/2, padding.t + plotH + 20);

      ctx.fillStyle = textColor;
      ctx.font = "12px system-ui";
      ctx.fillText(options.formatTop(v.value), x + barW/2, Math.max(14, y - 6));
    });

    ctx.textAlign = "left";
    ctx.font = "13px system-ui";
    ctx.fillStyle = textColor;
  }

  function renderChart(store, monthKey){
    const agg = buildWeekdayAgg(store, monthKey);
    const metric = $("chartMetric").value || "visitors_qty";
    $("chartMetric").setAttribute("data-current", metric);

    let isMoney = false;

    const values = agg.map((a, i) => {
      let value = 0;

      if(metric === "visitors_qty"){
        value = a.visitorsQty;
      } else if(metric === "revenue_total"){
        value = a.revenueTotal;
        isMoney = true;
      } else if(metric.startsWith("qty:")){
        const typeId = metric.slice(4);
        value = a.qtyByType[typeId] || 0;
      } else if(metric.startsWith("rev:")){
        const typeId = metric.slice(4);
        value = a.revByType[typeId] || 0;
        isMoney = true;
      }

      return { label: weekdayLabels[i], value };
    });

    const formatY = (val) => isMoney ? `Bs ${Math.round(val)}` : String(Math.round(val));
    const formatTop = (val) => isMoney ? `Bs ${Math.round(val)}` : String(Math.round(val));
    drawBarChart(values, { formatY, formatTop });
  }

  function renderMonthlySummary(summary){
    $("monthSummaryRevenue").textContent = fmtMoney(summary.totalRevenue);
    $("monthSummaryVisitors").textContent = String(summary.visitorsQty);
    $("monthSummaryMeta").textContent = summary.daysCount
      ? `Días con registros: ${summary.daysCount} · Recorridos: ${summary.tripsCount}`
      : "Sin registros en el mes.";
    $("monthSummaryVisitorsMeta").textContent = summary.visitorsQty
      ? "Incluye todos los tipos de visitantes."
      : "Sin visitantes registrados.";

    $("monthVisitorsTbody").innerHTML = summary.visitorTypes.length
      ? summary.visitorTypes.map(row => `
          <tr>
            <td data-label="Tipo"><strong>${esc(row.label)}</strong></td>
            <td class="right" data-label="Cantidad"><strong>${row.qty}</strong></td>
            <td class="right" data-label="Total"><strong>${fmtMoney(row.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr class="summaryEmpty"><td colspan="3" class="muted" data-label="">Sin visitantes registrados.</td></tr>`;

    $("monthExtrasTbody").innerHTML = summary.extraTypes.length
      ? summary.extraTypes.map(row => `
          <tr>
            <td data-label="Extra"><strong>${esc(row.label)}</strong></td>
            <td class="right" data-label="Cantidad"><strong>${row.qty}</strong></td>
            <td class="right" data-label="Total"><strong>${fmtMoney(row.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr class="summaryEmpty"><td colspan="3" class="muted" data-label="">Sin extras registrados.</td></tr>`;
  }

  function renderMonthlyTable(store, monthKey){
    const days = listDaysForMonth(store, monthKey);
    const tbody = $("monthTbody");

    if(days.length === 0){
      tbody.innerHTML = `<tr><td colspan="4" class="muted">No hay registros para este mes.</td></tr>`;
      return;
    }

    tbody.innerHTML = days.map(date=>{
      const trips = store.days[date]?.trips || [];
      let entries=0,revenue=0;

      for(const t of trips){
        const c = calcTrip(t);
        entries += c.qtyVisitors || 0;
        revenue += c.incomeTotal;
      }

      return `
        <tr>
          <td><strong>${date}</strong><div class="muted" style="font-size:11px;margin-top:2px">Recorridos: ${trips.length}</div></td>
          <td class="right"><strong>${entries}</strong></td>
          <td class="right"><strong>${fmtMoney(revenue)}</strong></td>
          <td class="right"><div class="actions"><button class="ghost" data-act="goDay" data-date="${date}">Ver día</button></div></td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll("button[data-act='goDay']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const date = btn.getAttribute("data-date");
        $("listDate").value = date;
        $("month").value = toMonthKeyFromISODate(date);
        setActiveTab("daily");
        renderDaily();
        toast("Día cargado.");
      });
    });
  }

  function renderMonthly(){
    if(!$("panelMonthly").classList.contains("active")) return;

    refreshCatalogCache();

    const store = loadStore();
    const monthKey = String($("month").value || "").trim();
    $("monthBadge").textContent = monthKey || "—";

    if(!monthKey){
      $("monthSummaryRevenue").textContent = "Bs 0";
      $("monthSummaryVisitors").textContent = "0";
      $("monthSummaryMeta").textContent = "—";
      $("monthSummaryVisitorsMeta").textContent = "—";
      $("monthVisitorsTbody").innerHTML = "";
      $("monthExtrasTbody").innerHTML = "";
      $("monthTbody").innerHTML = `<tr><td colspan="4" class="muted">Selecciona un mes.</td></tr>`;
      $("monthInfo").innerHTML = "";
      return;
    }

    const summary = buildMonthlySummary(store, monthKey);
    renderMonthlySummary(summary);
    renderMonthlyTable(store, monthKey);

    $("monthInfo").innerHTML = `
      <span class="pill">Mes ${esc(monthKey)}</span>
      <strong>${summary.daysCount}</strong> días con registros · <strong>${summary.tripsCount}</strong> recorridos ·
      <strong>${summary.visitorsQty}</strong> visitantes · <strong>${fmtMoney(summary.totalRevenue)}</strong> ingresos.
    `;
  }

  // ===== Report / Export / Import =====
  function download(filename, text){
    const blob = new Blob([text], {type:"application/json;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function buildReportHTML(store, monthKey){
    const summary = buildMonthlySummary(store, monthKey);
    const days = listDaysForMonth(store, monthKey);

    const tr = days.map(date=>{
      const trips = store.days[date]?.trips || [];
      let entries=0, revenue=0;
      for(const t of trips){
        const c = calcTrip(t);
        entries += c.qtyVisitors || 0;
        revenue += c.incomeTotal;
      }
      return `
        <tr>
          <td>${date}</td>
          <td style="text-align:right"><strong>${entries}</strong></td>
          <td style="text-align:right"><strong>${fmtMoney(revenue)}</strong></td>
          <td style="text-align:right">${trips.length}</td>
        </tr>
      `;
    }).join("");

    const stamp = new Date().toLocaleString();

    const visitorRows = summary.visitorTypes.length
      ? summary.visitorTypes.map(row => `
          <tr>
            <td>${esc(row.label)}</td>
            <td style="text-align:right"><strong>${row.qty}</strong></td>
            <td style="text-align:right"><strong>${fmtMoney(row.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr><td colspan="3" style="color:#444;">Sin visitantes registrados.</td></tr>`;

    const extraRows = summary.extraTypes.length
      ? summary.extraTypes.map(row => `
          <tr>
            <td>${esc(row.label)}</td>
            <td style="text-align:right"><strong>${row.qty}</strong></td>
            <td style="text-align:right"><strong>${fmtMoney(row.subtotal)}</strong></td>
          </tr>
        `).join("")
      : `<tr><td colspan="3" style="color:#444;">Sin extras registrados.</td></tr>`;

    return `
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reporte mensual - ${monthKey}</title>
<style>
  body{font-family: Arial, Helvetica, sans-serif; margin:24px; color:#111;}
  h1{margin:0 0 6px; font-size:18px;}
  h2{margin:0 0 6px; font-size:14px;}
  .meta{font-size:12px; color:#444; margin-bottom:14px; line-height:1.45;}
  .summaryTop{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin: 10px 0 16px;}
  .summaryStat{border:1px solid #ddd; border-radius:10px; padding:10px;}
  .summaryStat .label{font-size:11px; color:#444; margin-bottom:6px;}
  .summaryStat .value{font-size:16px; font-weight:800;}
  .summaryStat .meta{font-size:11px; color:#444; margin-top:6px; line-height:1.35;}
  .summaryGrid{display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; margin-bottom: 8px;}
  .summaryBox{border:1px solid #ddd; border-radius:10px; padding:10px;}
  .summaryBox h2{margin:0 0 6px; font-size:12px;}
  table{width:100%; border-collapse:collapse; font-size:12px;}
  th, td{border:1px solid #ddd; padding:8px; vertical-align:top;}
  th{background:#f4f6f8; text-align:left;}
  tr{page-break-inside:avoid;}
  @media print{ body{margin:14mm;} }
</style>
</head>
<body>
  <h1>Reporte mensual — Granja (Mes ${monthKey})</h1>
  <div class="meta">Generado: ${stamp}</div>

  <div class="summaryTop">
    <div class="summaryStat">
      <div class="label">Total $ del mes</div>
      <div class="value">${fmtMoney(summary.totalRevenue)}</div>
      <div class="meta">Días con registros: ${summary.daysCount} · Recorridos: ${summary.tripsCount}</div>
    </div>
    <div class="summaryStat">
      <div class="label">Total visitantes del mes</div>
      <div class="value">${summary.visitorsQty}</div>
      <div class="meta">Incluye todos los tipos de visitantes.</div>
    </div>
  </div>

  <div class="summaryGrid">
    <div class="summaryBox">
      <h2>Detalle de visitantes</h2>
      <table>
        <thead>
          <tr>
            <th>Tipo</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Total (Bs)</th>
          </tr>
        </thead>
        <tbody>${visitorRows}</tbody>
      </table>
    </div>
    <div class="summaryBox">
      <h2>Detalle de extras</h2>
      <table>
        <thead>
          <tr>
            <th>Extra</th>
            <th style="text-align:right">Cantidad</th>
            <th style="text-align:right">Total (Bs)</th>
          </tr>
        </thead>
        <tbody>${extraRows}</tbody>
      </table>
    </div>
  </div>

  <h2 style="margin-top:16px;">Detalle por día</h2>
  <table>
    <thead>
      <tr>
        <th>Fecha</th>
        <th style="text-align:right">Visitantes</th>
        <th style="text-align:right">Total día</th>
        <th style="text-align:right">Recorridos</th>
      </tr>
    </thead>
    <tbody>${tr}</tbody>
  </table>

  <script>
    window.addEventListener("load", () => { try { window.focus(); } catch(e) {} window.print(); });
  </scr` + `ipt>
</body>
</html>`;
  }

  $("exportBtn").addEventListener("click", ()=>{
    const store = loadStore();
    const monthKey = String($("month").value || "").trim() || toMonthKeyFromISODate(toISODate(new Date()));
    const filename = `kalomai_granja_${monthKey}_export.json`;
    download(filename, JSON.stringify(store, null, 2));
    toast("Exportación generada.");
  });

  $("importBtn").addEventListener("click", ()=>{
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "application/json";
    input.addEventListener("change", async ()=>{
      const file = input.files?.[0];
      if(!file) return;
      try{
        const text = await file.text();
        const obj = JSON.parse(text);
        if(!obj || typeof obj !== "object" || typeof obj.days !== "object"){
          toast("Archivo inválido (estructura).");
          return;
        }
        for(const d of Object.keys(obj.days)){
          if(!Array.isArray(obj.days[d].trips)) obj.days[d].trips = [];
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        loadActiveTripFromStorage();
        renderDaily();
        renderMonthly();
        toast("Importación completada.");
      }catch{
        toast("No se pudo importar (JSON inválido).");
      }
    });
    input.click();
  });

  $("reportBtn").addEventListener("click", ()=>{
    const store = loadStore();
    const monthKey = String($("month").value || "").trim();
    if(!monthKey){
      toast("Selecciona un mes.");
      return;
    }
    const html = buildReportHTML(store, monthKey);
    const w = window.open("", "_blank");
    if(!w){ toast("No se pudo abrir el reporte (bloqueo de popups)."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  });

  $("openTariffBtn").addEventListener("click", ()=>{
    setActiveTab("tariff");
  });

  $("month").addEventListener("change", renderMonthly);
  const chartMetricEl = $("chartMetric");
  if(chartMetricEl){
    chartMetricEl.addEventListener("change", ()=>{
      const store = loadStore();
      const monthKey = String($("month").value || "").trim();
      if(monthKey) renderChart(store, monthKey);
    });
  }

  // ===== Tarifario UI =====
  let editingTariffId = null;
  const tariffLabelEl = $("tariffLabel");
  const tariffCategoryEl = $("tariffCategory");
  const tariffPriceEl = $("tariffPrice");
  const tariffEnabledEl = $("tariffEnabled");
  const tariffSaveBtn = $("tariffSaveBtn");
  const tariffCancelBtn = $("tariffCancelBtn");
  const tariffFormTitle = $("tariffFormTitle");

  function resetTariffForm(){
    editingTariffId = null;
    tariffFormTitle.textContent = "Nuevo ítem";
    tariffLabelEl.value = "";
    tariffCategoryEl.value = "extra";
    tariffPriceEl.value = "0";
    tariffEnabledEl.value = "true";
    tariffCancelBtn.disabled = true;
  }

  function loadTariffIntoForm(item){
    editingTariffId = item.id;
    tariffFormTitle.textContent = "Editar ítem";
    tariffLabelEl.value = item.label;
    tariffCategoryEl.value = (item.category === "visitor") ? "visitor" : "extra";
    tariffPriceEl.value = String(safeMoney(item.defaultPrice));
    tariffEnabledEl.value = item.isEnabled ? "true" : "false";
    tariffCancelBtn.disabled = false;
  }

  tariffCancelBtn.addEventListener("click", ()=>{
    resetTariffForm();
    toast("Edición cancelada.");
  });

  tariffSaveBtn.addEventListener("click", ()=>{
    const label = String(tariffLabelEl.value || "").trim();
    const category = (tariffCategoryEl.value === "visitor") ? "visitor" : "extra";
    const defaultPrice = safeMoney(tariffPriceEl.value);
    const isEnabled = tariffEnabledEl.value === "true";

    if(label.length < 2){
      toast("El nombre debe tener al menos 2 caracteres.");
      tariffLabelEl.focus();
      return;
    }

    const cat = loadCatalog();
    const now = new Date().toISOString();

    if(editingTariffId){
      const idx = cat.findIndex(x => x.id === editingTariffId);
      if(idx === -1){
        toast("No se encontró el ítem a editar.");
        resetTariffForm();
        return;
      }
      cat[idx] = { ...cat[idx], label, category, defaultPrice, isEnabled, updatedAt: now };
      saveCatalog(cat);
      toast("Ítem actualizado.");
      resetTariffForm();
    } else {
      const newItem = { id: uid(), label, category, defaultPrice, isEnabled, createdAt: now, updatedAt: now };
      cat.push(newItem);
      saveCatalog(cat);
      toast("Ítem creado.");
      resetTariffForm();
    }
  });

  $("tariffResetBtn").addEventListener("click", ()=>{
    if(!confirmDanger("¿Restaurar el tarifario base? Esto reemplaza el tarifario actual (no borra recorridos).")) return;
    seedBaseCatalog();
    refreshCatalogCache();
    rebuildItemTypeSelect();
    rebuildChartMetricOptions();
    renderTariff();
    renderDaily();
    renderMonthly();
    toast("Tarifario base restaurado.");
  });

  function renderTariff(){
    if(!$("panelTariff").classList.contains("active")) return;

    refreshCatalogCache();
    const tbody = $("tariffTbody");
    const sorted = CATALOG.slice().sort((a,b)=>a.label.localeCompare(b.label));

    if(sorted.length === 0){
      tbody.innerHTML = `<tr><td colspan="5" class="muted">No hay ítems en el tarifario.</td></tr>`;
      return;
    }

    tbody.innerHTML = sorted.map(it=>{
      const used = isTypeUsedInTrips(it.id);
      const state = it.isEnabled ? "Habilitado" : "Deshabilitado";
      const stateDot = it.isEnabled ? "var(--ok)" : "var(--danger)";
      const delDisabled = used ? "disabled" : "";
      const delTitle = used ? "title='No se puede borrar: ya fue usado. Deshabilítalo.'" : "title='Borrar (solo si nunca se usó)'";
      return `
        <tr>
          <td><strong>${esc(it.label)}</strong></td>
          <td>${esc(catLabel(it.category))}</td>
          <td class="right">${fmtMoney(safeMoney(it.defaultPrice))}</td>
          <td>
            <span class="badge" style="border-color:rgba(255,255,255,.10)"><span class="dot" style="background:${stateDot}"></span>${state}</span>
          </td>
          <td class="right">
            <div class="actions">
              <button class="ghost" data-act="tEdit" data-id="${esc(it.id)}">Editar</button>
              <button class="${it.isEnabled ? "danger" : "ok"}" data-act="tToggle" data-id="${esc(it.id)}">
                ${it.isEnabled ? "Deshabilitar" : "Habilitar"}
              </button>
              <button class="danger" data-act="tDelete" data-id="${esc(it.id)}" ${delDisabled} ${delTitle}>Borrar</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll("button[data-act='tEdit']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const item = CATALOG.find(x => x.id === id);
        if(!item){ toast("No se encontró el ítem."); return; }
        loadTariffIntoForm(item);
        toast("Modo edición.");
      });
    });

    document.querySelectorAll("button[data-act='tToggle']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        const cat = loadCatalog();
        const idx = cat.findIndex(x => x.id === id);
        if(idx === -1){ toast("No se encontró el ítem."); return; }
        cat[idx].isEnabled = !cat[idx].isEnabled;
        cat[idx].updatedAt = new Date().toISOString();
        saveCatalog(cat);
        toast(cat[idx].isEnabled ? "Ítem habilitado." : "Ítem deshabilitado.");
      });
    });

    document.querySelectorAll("button[data-act='tDelete']").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        if(isTypeUsedInTrips(id)){
          toast("No se puede borrar: ya fue usado. Deshabilítalo.");
          return;
        }
        if(!confirmDanger("¿Borrar este ítem del tarifario?")) return;

        let cat = loadCatalog();
        cat = cat.filter(x => x.id !== id);
        saveCatalog(cat);

        if(editingTariffId === id) resetTariffForm();
        toast("Ítem borrado.");
      });
    });

    $("tariffCount").textContent = String(CATALOG.length);
  }

  // ===== Boot =====
  function initDefaults(){
    const today = toISODate(new Date());
    $("listDate").value = today;
    $("newTripDate").value = today;
    $("month").value = today.slice(0,7);
    $("monthBadge").textContent = $("month").value;
  }

  function boot(){
    initDefaults();
    refreshCatalogCache();
    rebuildItemTypeSelect();
    rebuildChartMetricOptions();
    resetTariffForm();

    loadActiveTripFromStorage();
    renderDaily();
    renderMonthly();
  }

  boot();
})();
</script>
</body>
</html>
